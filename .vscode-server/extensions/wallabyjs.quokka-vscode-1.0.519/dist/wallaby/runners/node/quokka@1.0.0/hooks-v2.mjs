import{fileURLToPath}from"url";import{extname}from"path";import{readFileSync}from"fs";import arg from"arg";function getTracer(){return global.$_$tracer}import{getFormat,transformSource,resolve as resolveImplmentation}from"./hooks.mjs";const extensionFormatMap={__proto__:null,".cjs":"commonjs",".js":"module",".mjs":"module"},legacyExtensionFormatMap={__proto__:null,".cjs":"commonjs",".js":"commonjs",".json":"commonjs",".mjs":"module",".node":"commonjs"};function getOptionValue(e){return parseOptions(),options[e]}let options;function parseOptions(){options||(options={"--preserve-symlinks":!1,"--preserve-symlinks-main":!1,"--input-type":void 0,"--experimental-specifier-resolution":"explicit","--experimental-policy":void 0,"--conditions":[],"--pending-deprecation":!1,...parseArgv(getNodeOptionsEnvArgv()),...parseArgv(process.execArgv),...getOptionValuesFromOtherEnvVars()})}function parseArgv(e){return arg({"--preserve-symlinks":Boolean,"--preserve-symlinks-main":Boolean,"--input-type":String,"--experimental-specifier-resolution":String,"--es-module-specifier-resolution":"--experimental-specifier-resolution","--experimental-policy":String,"--conditions":[String],"--pending-deprecation":Boolean,"--experimental-json-modules":Boolean,"--experimental-wasm-modules":Boolean},{argv:e,permissive:!0})}function getNodeOptionsEnvArgv(){const e=[];return ParseNodeOptionsEnvVar(process.env.NODE_OPTIONS||"",e)}function ParseNodeOptionsEnvVar(e,o){const t=[];let n=!1,r=!0;for(let i=0;i<e.length;++i){let a=e[i];if("\\"===a&&n){if(i+1===e.length)return o.push("invalid value for NODE_OPTIONS (invalid escape)\n"),t;a=e[++i]}else{if(" "===a&&!n){r=!0;continue}if('"'===a){n=!n;continue}}r?(t.push(a),r=!1):t[t.length-1]+=a}return n&&o.push("invalid value for NODE_OPTIONS (unterminated string)\n"),t}function getOptionValuesFromOtherEnvVars(){const e={};return"1"===process.env.NODE_PENDING_DEPRECATION&&(e["--pending-deprecation"]=!0),e}const experimentalSpeciferResolution=getOptionValue("--experimental-specifier-resolution"),experimentalJsonModules=getOptionValue("--experimental-json-modules"),experimentalWasmModules=getOptionValue("--experimental-wasm-modules"),packageJSONCache=new Map;function getPackageConfig(e){const o=packageJSONCache.get(e);if(void 0!==o)return o;let t,n;try{t=readFileSync(e,"utf8")}catch(e){}if(void 0===t){const o={pjsonPath:e,exists:!1,main:void 0,name:void 0,type:"none",exports:void 0,imports:void 0};return packageJSONCache.set(e,o),o}try{n=JSON.parse(t)}catch(e){throw new Error("Unexpected result: "+t+e.toString())}let{imports:r,main:i,name:a,type:s}=n;const{exports:l}=n;"object"==typeof r&&null!==r||(r=void 0),"string"!=typeof i&&(i=void 0),"string"!=typeof a&&(a=void 0),"module"!==s&&"commonjs"!==s&&(s="none");const p={pjsonPath:e,exists:!0,main:i,name:a,type:s,exports:l,imports:r};return packageJSONCache.set(e,p),p}function getPackageScopeConfig(e){let o=new URL("./package.json",e);for(;;){if(o.pathname.endsWith("node_modules/package.json"))break;const t=getPackageConfig(fileURLToPath(o),e);if(t.exists)return t;const n=o;if(o=new URL("../package.json",o),o.pathname===n.pathname)break}const t=fileURLToPath(o),n={pjsonPath:t,exists:!1,main:void 0,name:void 0,type:"none",exports:void 0,imports:void 0};return packageJSONCache.set(t,n),n}function defaultGetFormat(e,o,t){if(e.startsWith("node:"))return{format:"builtin"};const n=new URL(e);if("data:"===n.protocol){const[,e]=/^([^/]+\/[^;,]+)(?:[^,]*?)(;base64)?,/.exec(n.pathname)||[null,null,null];return{format:{__proto__:null,"text/javascript":"module","application/json":experimentalJsonModules?"json":null,"application/wasm":experimentalWasmModules?"wasm":null}[e]||null}}if("file:"===n.protocol){const o=extname(n.pathname);let t;if(t=".js"===o?"module"===getPackageScopeConfig(n.href).type?"module":"commonjs":extensionFormatMap[o],!t){if("node"!==experimentalSpeciferResolution)throw new ERR_UNKNOWN_FILE_EXTENSION(o,fileURLToPath(e));process.emitWarning("The Node.js specifier resolution in ESM is experimental.","ExperimentalWarning"),t=legacyExtensionFormatMap[o]}return{format:t||null}}return{format:null}}export async function load(e,o,t){const n=(await getFormat(e,o,defaultGetFormat)).format;let r;if("builtin"!==n&&"commonjs"!==n){const o=getTracer();if(o&&o._esm){const t=o._esm;if(e===t.scratchFileUrl)return{format:n,source:t.scratchFileContent,shortCircuit:!0}}const{source:i}=await t(e,{format:n},t);if(null==i)throw new Error(`Failed to load raw source: Format was '${n}' and url was '${e}''.`);const a=(e,o,t)=>({source:e}),{source:s}=await transformSource(i,{url:e,format:n},a);r=s}else{const{source:o}=await t(e,{format:n},t);r=o}return{format:n,source:r}}export async function resolve(e,o,t){return resolveImplmentation(e,o,t)}